<!--
  ~ Copyright (c) 2001-2009, TIBCO Software Inc.
  ~ Use, modification, and distribution subject to terms of license.
  -->

<html>
  <head>
    <title>General Interface Test Recorder</title>

<script type="text/javascript" language="JavaScript">

  window.state = {inited:false, editor:null, paused:false, asserting:false, waiting:false, loadListener:null};

  function onReady() {
    window.setTimeout(function() {
      state.editor = window["gippeditor"];

      window.onbeforeunload = new Function("cleanAndClose();");
      window.onresize = updateHeight;

      if (window.document.addEventListener) {
        window.document.addEventListener("click", onAppClick, true);
      } else {
        window.document.onclick = onAppClick;
      }

      updateHeight();

      if (state.editor) {
        window.setTimeout(loadApp, 250);
        state.editor.onRecorderLaunched();
      } else
        if (confirm("This page must be launched directly from General Interface Builder. Close window?"))
          cleanAndClose(true);
    }, 250);
  }

  function cleanAndClose(bClose) {
    window.state = {};
    if (window.gippeditor) {
      window.gippeditor.onRecorderStopped();
      window.gippeditor = null;
    }

    if (bClose)
      window.close();
  }

  function updateHeight() {
    var cnt = document.getElementById("appContainer");
    var ctrl = document.getElementById("recorderControls");
    cnt.style.height = document.body.clientHeight - ctrl.offsetHeight;
  }

  function loadApp() {
    var cnt = document.getElementById("appContainer");
    var script = document.createElement("script");
    script.setAttribute("type", "text/javascript");
    script.setAttribute("src", state.editor.getJsxSrc());
    script.setAttribute("jsxapppath", state.editor.getJsxAppPath());
    script.setAttribute("caption", ""); // prevent title from changing
    cnt.appendChild(script);

    state.loadListener = window.setInterval(checkLoaded, 100);
  }

  function checkLoaded() {
    if (exitOnEditorGone()) return;

    if (!state.inited && window.jsx3 && jsx3.lang && jsx3.lang.AOP && jsx3.gui && jsx3.gui.Interactive) {
      state.inited = true;
      window.clearInterval(state.loadListener);

      var classes = [jsx3.gui.Interactive.jsxclass];
      var pkgs = jsx3.lang.Package.getPackages();
      for (var i = 0; i < pkgs.length; i++) {
        var c = pkgs[i].getClasses();
        for (var j = 0; j < c.length; j++) {
          if (jsx3.$A(c[j].getInterfaces()).contains(jsx3.gui.Interactive.jsxclass))
            classes.push(c[j]);
        }
      }
      
//      state.editor.getPlugIn().getLog().warn("Registering recorder. [" + classes + "]");

      jsx3.lang.AOP.pcrem("evtCP"); // just in case...
      jsx3.lang.AOP.pc("evtCP", {classes:classes, methods:"doEvent"});

      jsx3.lang.AOP.before("evtCP", function(strType, objContext) {
        if (!state.paused && !state.asserting && !state.waiting) {
          if (exitOnEditorGone()) return;

          var hasListener = this.hasEvent(strType) || this.getSubscriberCount(strType) > 0;

          state.editor.onModelEvent(this, strType, objContext, hasListener);
        }
      });
    }
  }

  function exitOnEditorGone() {
    if (state.editor && !state.editor.isAlive()) {
      if (confirm("General Interface Builder is no longer associated with this recorder, perhaps because it was reloaded. Close window?")) {
        cleanAndClose(true);
        return true;
      }
    }
    return false;
  }

  function onPause() {
    var btn = document.getElementById("playPause");
    if (state.paused) {
      state.paused = false;
      btn.innerHTML = "Pause";
      btn.className = "recorderBtn activeBtn";
    } else {
      state.paused = true;
      btn.innerHTML = "Play";
      btn.className = "recorderBtn";
    }
  }

  function onWait() {
    if (state.asserting)
      onAssert();

    var btn = document.getElementById("wait");
    if (state.waiting) {
      state.waiting = false;
      btn.innerHTML = "Wait";
      btn.className = "recorderBtn";
    } else {
      state.waiting = true;
      btn.innerHTML = "Cancel Wait";
      btn.className = "recorderBtn activeBtn";
    }
  }

  function onAssert() {
    if (state.waiting)
      onWait();

    var btn = document.getElementById("assert");
    if (state.asserting) {
      state.asserting = false;
      btn.innerHTML = "Assert";
      btn.className = "recorderBtn";
    } else {
      state.asserting = true;
      btn.innerHTML = "Cancel Assert";
      btn.className = "recorderBtn activeBtn";
    }
  }

  function onStop() {
    cleanAndClose(true);
  }

  function onAppClick(event) {
    if ((state.asserting || state.waiting) && window.jsx3 && jsx3.html && jsx3.html.getJSXParent) {
      var e = jsx3.gui.Event.wrap(event);
      var objJSX = jsx3.html.getJSXParent(e.srcElement());
      if (objJSX) {
        if (exitOnEditorGone()) return;

        try {
          state.editor.onAssert(objJSX, state.waiting);
        } catch (e) {
          alert(e.message + "\n" + e.stack);
        }

        if (state.waiting)
          onWait();
        else
          onAssert();
      }

      if (event.stopPropagation) {
        event.stopPropagation();
        event.preventDefault();
      } else {
        event.cancelBubble = true;
        event.keyCode = 0;
        event.returnValue = false;
      }
    }
  }

</script>

<style type="text/css">
  body {
    position: absolute;
    width: 100%;
    height: 100%;
    left: 0px;
    top: 0px;
    padding: 0px;
    margin: 0px;
    border: 0px;
    overflow: hidden;
  }

  #recorderControls {
    height: 20px;
    overflow: hidden;
    background-color: #666666;
    font-size: 11px;
    font-family: Verdana, sans-serif;
  }

  .padding {
    padding: 2px 5px;
  }

  .recorderBtn {
    height: 16px;
    overflow: hidden;
    background-color: #DDDDDD;
    color: #333333;
    padding: 0px 5px;
    float: left;
    cursor: pointer;
    margin-right: 8px;
  }

  .activeBtn {
    background-color: #BBFFDD;
  }

  #stop {
    float: right;
    margin-right: 0px;
    background-color: #FFCCCC;
  }

  #appContainer {
    width: 100%;
    overflow: hidden;
    background-color: #EEEEEE;
  }
</style>
  </head>
  <body onload="onReady()" SCROLL="no">
    <div id="recorderControls">
      <div class="padding">
        <div id="playPause" class="recorderBtn activeBtn" onclick="onPause();">Pause</div>
        <div id="assert" class="recorderBtn" onclick="onAssert();">Assert</div>
        <div id="wait" class="recorderBtn" onclick="onWait();">Wait</div>
        <div id="stop" class="recorderBtn" onclick="onStop();">Stop</div>
      </div>
    </div>
    <div id="appContainer"></div>
  </body>
</html>
