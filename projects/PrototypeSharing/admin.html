<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Prototype Library Administration</title>
    <style type="text/css">
		@import "../jsclient/dojo/resources/dojo.css";
		@import "../jsclient/dojox/grid/resources/Grid.css";
		@import "../jsclient/dojox/grid/resources/tundraGrid.css";
		@import "../jsclient/dijit/themes/tundra/tundra.css";
		@import "../jsclient/dojox/highlight/resources/highlight.css";
    </style>
	<link rel="stylesheet" href="../css/adminInterface.css" type="text/css" media="screen" />	
  	<script djConfig="isDebug:true, parseOnLoad: true" src="../jsclient/dojo/dojo.js" type="text/javascript"></script>
	<script type="text/javascript">
		var path = location.pathname.match(/(.*\/)[^\/]*$/)[1];
		//dojo.require("dojox.data.ClientFilter");
		dojo.require("dojo.cookie");
		dojo.require("dojox.data.PersevereStore");
		dojo.require("dojox.grid.DataGrid");
		dojo.require("dijit.layout.BorderContainer");
		dojo.require("dijit.layout.TabContainer");
		dojo.require("dijit.layout.ContentPane");
		dojo.require("dojox.highlight");
		dojo.require("dojox.highlight.languages.xml");
		
		var prototypeStore = new dojox.data.PersevereStore({target:"/Prototype/", idAsRef: true}); // persevere stores are auto-generated
		var logStore = new dojox.data.PersevereStore({target:"/Log/", idAsRef: true}); // persevere stores are auto-generated
		function requery(status){
			componentGrid.setQuery({status:status});
		}
		function setText(element, text){
			element.innerHTML = text && text.toString().replace(/</g,"&lt;");
		}
		dojo.addOnLoad(function(){
			dojo.connect(componentGrid,"onRowClick", function(event){
				selectedItem = event.grid.getItem(event.rowIndex);
				var sourceCode = prototypeStore.getValue(selectedItem, "component");
				sourceCode = sourceCode && sourceCode.toString().replace(/</g,"&lt;");
				sourceTab.attr("content", sourceCode);
				dojox.highlight.init(sourceTab.containerNode);
				setText(dojo.byId("author-detail"), prototypeStore.getValue(selectedItem, "user"));
				setText(dojo.byId("status-detail"), prototypeStore.getValue(selectedItem, "status"));
				setText(dojo.byId("version-detail"), prototypeStore.getValue(selectedItem, "version"));
				setText(dojo.byId("downloads-detail"), prototypeStore.getValue(selectedItem, "downloads"));
				setText(dojo.byId("uploaded-detail"), prototypeStore.getValue(selectedItem, "uploaded"));
				setText(dojo.byId("rating-detail"), prototypeStore.getValue(selectedItem, "rating"));
				setText(dojo.byId("category-detail"), prototypeStore.getValue(selectedItem, "category"));
				setText(dojo.byId("description-detail"), prototypeStore.getValue(selectedItem, "description"));
			});
			dojo.connect(activityGrid,"onRowClick", function(event){
				selectedItem = event.grid.getItem(event.rowIndex);
				setText(dojo.byId("log-user-detail"), logStore.getValue(selectedItem, "user"));
				setText(dojo.byId("log-action-detail"), logStore.getValue(selectedItem, "action"));
				setText(dojo.byId("log-notes-detail"), logStore.getValue(selectedItem, "notes"));
			});
			var tabElement = infoPane.tablist.tablistWrapper.children[0];
			tabElement.style.width = "100%";
			var componentActions = dojo.byId("component-actions");
			componentActions.style.display = "inline-block";
			tabElement.appendChild(componentActions);
			setText(dojo.byId("username"), "John Adams");
			
			dojo.connect(dojo.byId("download"), "onclick", function(){
				var id = prototypeStore.getIdentity(selectedItem);
				window.location.href = "/Prototype/" + id + ".component";
			});
			dojo.connect(dojo.byId("accept-button"), "onclick", function(){
				prototypeStore.setValue(selectedItem, "enabled", true);
				prototypeStore.setValue(selectedItem, "status", "Accepted");
				prototypeStore.save();
				logStore.newItem({
					prototype_id:selectedItem.id,
					action: "Accepted",
					notes: null 
				});
				logStore.save();
			});
			dojo.connect(dojo.byId("prohibit-button"), "onclick", function(){
				var reason = prompt("Enter the reason for prohibiting");
				if(typeof reason === "string"){
					prototypeStore.setValue(selectedItem, "enabled", false);
					prototypeStore.setValue(selectedItem, "status", "Prohibited");
					prototypeStore.save();
					logStore.newItem({
						prototype_id:selectedItem.id,
						action: "Prohibited",
						notes: reason 
					});
					logStore.save();
				}
			});
			dojo.connect(dojo.byId("feature-button"), "onclick", function(){
				prototypeStore.setValue(selectedItem, "featured", true);
				prototypeStore.setValue(selectedItem, "enabled", true);
				prototypeStore.setValue(selectedItem, "status", "Featured");
				logStore.newItem({
					prototype_id:selectedItem.id,
					action: "Featured",
					notes: null 
				});
				logStore.save();

				prototypeStore.save();
			});
			dojo.connect(dojo.byId("filter-box-form"), "onsubmit", function(event){
				componentGrid.setQuery("?fulltext('" + dojo.byId("filter-box").value.replace(/'/g,"\\'") + "')");
				prototypeStore.save();
				dojo.stopEvent(event);
			});
		});
		function dateFormatter(date){
			return date && (date.getMonth() + '/' + date.getDate() + '/' + date.getFullYear());
		}
		function getStatus(rowIndex, item){
	        if(!item){
	                return this.defaultValue;
	        }
	        if(prototypeStore.getValue(item, "featured")){
				return "Featured";
			}
	        if(prototypeStore.getValue(item, "enabled")){
				return "Accepted";
			}
			return "Flagged";
	 	}
		function getDelete(){
			return "delete";
		}
	</script>
</head>
  
  <body class="tundra" id="adminInterface">
  		<div id="app-border" dojoType="dijit.layout.BorderContainer">
        <div id="header-pane" dojoType="dijit.layout.ContentPane" splitter="false" region="top" style="height:78px;">
	      <h1>General Interface</h1>
		  <h2>Prototype Library Administration</h2>
		</div>
		<div dojoType="dijit.layout.TabContainer" region="center" tabStrip="true">
			<div id="user">
				<span id="username"></span>
				<span class="verticalRule"></span>
				<span id="logout">Logout</span>
			</div>
	  		<div id="component-border" dojoType="dijit.layout.BorderContainer" title="Components"
			style="width: 90%; border: 2px solid blue; ">
		
				<div dojoType="dijit.layout.ContentPane" region="center" role="main">
					<button onclick="componentGrid.setQuery('')">All</button>
					<button onclick="requery('Accepted')">Accepted</button>
					<button onclick="requery('Featured')">Featured</button>
					<span class="horizontal-rule"></span>
					<button onclick="requery('New')">New</button>
					<button onclick="requery('Flagged')">Flagged</button>
					<button onclick="requery('Rejected')">Rejected</button>
					<form id="filter-box-form"><input id="filter-box" type="text"></input></form>
					<table rowSelector="20px" rowsPerPage="20" query="''" store="prototypeStore" id="component-grid" jsid="componentGrid" dojoType="dojox.grid.DataGrid" style="height:300px">
						<thead>
							<tr>
								<th width="80px" field="status">Status</th>
								<th editable="true" width="auto" field="name">Name</th>
								<th width="80px" field="user">Author</th>
								<th width="80px" field="rating">Rating</th>
								<th width="80px" field="downloads">Downloads</th>
								<th width="80px" field="category">Category</th>
								<th width="80px" field="uploaded" formatter="dateFormatter">Upload Date</th>
								<th width="80px" get="getDelete">Delete</th>
							</tr>
						</thead>
					</table>    
				</div>
		        <div id="info-pane" jsid="infoPane" dojoType="dijit.layout.TabContainer" splitter="true" region="bottom" style="height:250px">
		        	<div id="component-actions">
		        		<button id="accept-button">Accept</button>
						<button id="prohibit-button">Prohibit</button>
						<button id="feature-button">Feature</button>
					</div>
					<div id="info-tab" jsid="infoTab" dojoType="dijit.layout.ContentPane" title="Information" iconClass="plusIcon" tooltip="Information about component">
						<div id="info-description"></div>
						<div id="info-details">
							<hr />
							<span>Author:</span><span id="author-detail"></span>
							<hr />
							<span>Status:</span><span id="status-detail"></span>
							<hr />
							<span>Version:</span><span id="version-detail"></span>
							<hr />
							<span>Downloads:</span><span id="downloads-detail"></span>
							<hr />
							<span>Uploaded:</span><span id="uploaded-detail"></span>
							<hr />
							<span>Rating:</span><span id="rating-detail"></span>
							<hr />
							<span>Category:</span><span id="category-detail"></span>
							<hr />
							<span>Description:</span><span id="description-detail"></span>
							<hr />
							<button id="download">Download</button>
						</div>
					</div>
					<div id="source-tab" jsid="sourceTab" dojoType="dijit.layout.ContentPane" title="Source Code" iconClass="plusIcon" tooltip="Source Code">
					</div>
		        </div>
			</div>
			<div id="activity-tab" dojoType="dijit.layout.BorderContainer" title="Activity Log" iconClass="plusIcon" tooltip="Activity Log">
		        <div id="log-pane" jsid="logPane" dojoType="dijit.layout.ContentPane" splitter="true" region="center">
					<h2>Activity Log</h2>
					<table rowSelector="20px" rowsPerPage="20" query="''" store="logStore" id="activity-grid" jsid="activityGrid" dojoType="dojox.grid.DataGrid" style="height:300px">
						<thead>
							<tr>
								<th editable="true" width="80px" field="user">User</th>
								<th editable="true" width="auto" field="action">Action</th>
								<th editable="true" width="80px" field="date" formatter="dateFormatter">Date</th>
							</tr>
						</thead>
					</table>    
				</div>
				<div id="log-description-pane" jsid="logDescriptionPane" dojoType="dijit.layout.ContentPane" splitter="true" region="bottom" style="height:250px">
					<div id="log-details">
						<hr />
						<span>User:</span><span id="log-user-detail"></span>
						<hr />
						<span>Action:</span><span id="log-action-detail"></span>
						<hr />
						<span>Notes:</span><span id="log-notes-detail"></span>
						<hr />
					</div>
					
				</div>
			</div>

		</div>
	</div>

  	
  </body>
</html>